<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario SAP B1</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .product { background: white; padding: 20px; margin: 15px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 6px solid #0055cc; }
    .disponible-verde { color: #2e8b57; font-weight: bold; }
    .comprometido-rojo { color: #d9534f; }
    .transito-info { background: #fff4e6; padding: 10px; border-radius: 6px; margin: 10px 0; }
    .cache-info { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>üì¶ Inventario SAP B1</h1>
      <div>
        <a href="/" class="btn btn-outline-primary me-2">‚Üê Volver al inicio</a>
        <a href="/cargar-inventario-manual" class="btn btn-warning">üîÑ Recargar Inventario</a>
      </div>
    </div>
    <div class="cache-info">
      <h5>üîÑ Informaci√≥n de cach√©</h5>
      <p>√öltima actualizaci√≥n: <strong><%= ultimaActualizacion ? ultimaActualizacion.toLocaleString() : 'Nunca' %></strong></p>
    </div>
    <div class="row mb-4">
      <div class="col-md-6">
        <input type="text" id="search" class="form-control" placeholder="Buscar c√≥digo, nombre...">
      </div>
      <div class="col-md-6">
        <select id="filterTipoBodega" class="form-select">
          <option value="">Todos los tipos de bodega</option>
          <option value="De Stock">De Stock</option>
          <option value="De Exhibici√≥n">De Exhibici√≥n</option>
          <option value="De Liquidaci√≥n">De Liquidaci√≥n</option>
          <option value="De Provisi√≥n">De Provisi√≥n</option>
          <option value="De Consignaci√≥n">De Consignaci√≥n</option>
          <option value="Defectuosos">Defectuosos</option>
          <option value="Otros">Otros</option>
        </select>
      </div>
    </div>
    <div id="products">
      <div class="text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Cargando inventario...</p>
      </div>
    </div>
  </div>
  <script>
    let products = <%- JSON.stringify(productos) %>;
    function displayProducts(list) {
      const container = document.getElementById("products");
      if (list.length === 0) { 
        container.innerHTML = "<div class='alert alert-warning'>No se encontraron productos.</div>"; 
        return; 
      }
      let html = "";
      list.forEach(p => {
        const tipoFiltro = document.getElementById("filterTipoBodega").value;
        const bodegasFiltradas = tipoFiltro ? p.bodegas.filter(b => getWhsType(b.WhsCode) === tipoFiltro) : p.bodegas;
        if (bodegasFiltradas.length === 0) return;
        let bodegasHtml = "<table class='table table-sm'><thead><tr><th>Bodega</th><th>Total</th><th>Comprometido</th><th>Disponible</th></tr></thead><tbody>";
        bodegasFiltradas.forEach(b => {
          bodegasHtml += "<tr><td>" + b.WhsCode + "</td><td>" + b.OnHand + "</td><td class='comprometido-rojo'>" + b.IsCommited + "</td><td><span class='disponible-verde'>" + b.DisponibleFinal + "</span></td></tr>";
        });
        bodegasHtml += "</tbody></table>";
        const transitoHtml = p.Transito_Disponible > 0 
          ? "<div class='transito-info'><strong>üöö Importaci√≥n en tr√°nsito:</strong> Total: " + p.Transito_Total + ", Disponible: " + p.Transito_Disponible + "</div>"
          : "";
        html += "<div class='product'>" +
          "<h3>" + p.ItemCode + "</h3>" +
          "<p><strong>Nombre:</strong> " + p.ItemName + "</p>" +
          "<p><strong>Precio:</strong> S/ " + (p.PrecioVenta ? p.PrecioVenta.toFixed(2) : "N/A") + "</p>" +
          bodegasHtml +
          transitoHtml +
          "</div>";
      });
      container.innerHTML = html;
    }
    function getWhsType(whsCode) {
      if (whsCode.endsWith('201')) return 'De Exhibici√≥n';
      if (whsCode.endsWith('01') && !whsCode.endsWith('201')) return 'De Stock';
      if (whsCode.endsWith('04')) return 'De Liquidaci√≥n';
      if (whsCode.endsWith('08')) return 'De Provisi√≥n';
      if (whsCode.endsWith('03')) return 'De Consignaci√≥n';
      if (whsCode.endsWith('02')) return 'Defectuosos';
      return 'Otros';
    }
    let searchTimeout;
    document.getElementById("search").addEventListener("input", () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(applyFilters, 300);
    });
    document.getElementById("filterTipoBodega").addEventListener("change", applyFilters);
    function applyFilters() {
      const term = document.getElementById("search").value.toLowerCase();
      const tipoBodega = document.getElementById("filterTipoBodega").value;
      const filtered = products.filter(p => {
        const matchSearch = !term || 
          p.ItemCode.toLowerCase().includes(term) || 
          p.ItemName.toLowerCase().includes(term);
        const matchTipoBodega = !tipoBodega || 
                               p.bodegas.some(b => getWhsType(b.WhsCode) === tipoBodega);
        return matchSearch && matchTipoBodega;
      });
      displayProducts(filtered);
    }
    applyFilters();
  </script>
</body>
</html>